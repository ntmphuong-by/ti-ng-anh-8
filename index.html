<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English 8 - Global Success (Unit 7-9) - IOE Practice</title>
    <style>
        :root { --primary: #1565c0; --secondary: #42a5f5; --bg: #e3f2fd; --explain-bg: #e8f5e9; --explain-text: #2e7d32; --wrong: #c62828; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; user-select: none; padding-bottom: 50px; }
        
        /* Hi·ªáu ·ª©ng n·ªÅn nh·∫π nh√†ng */
        .bg-decor { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.1; background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); }

        .container { 
            background: rgba(255,255,255,0.98); 
            border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
            padding: 30px; 
            max-width: 900px; 
            width: 90%; 
            margin-top: 30px; 
            text-align: center; 
            z-index: 1; 
            border-top: 5px solid var(--primary); 
            position: relative;
            min-height: 400px;
            display: flex; flex-direction: column; justify-content: center;
        }

        .screen { width: 100%; }
        .hidden { display: none !important; }

        /* Ti√™u ƒë·ªÅ */
        h1 { color: var(--primary); margin-bottom: 5px; font-size: 1.8rem; text-transform: uppercase; letter-spacing: 1px; }
        h2 { color: #555; font-size: 1rem; font-weight: normal; margin-bottom: 20px; }

        /* Khung c√¢u h·ªèi */
        .question-box { 
            background: #fff; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 15px 0; 
            font-size: 1.25rem; 
            color: #333; 
            font-weight: 600; 
            border: 2px solid #e0e0e0; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.02);
            text-align: left;
            line-height: 1.5;
        }
        
        /* ƒê·∫∑c bi·ªát cho b√†i ƒë·ªçc */
        .reading-text {
            font-size: 1rem;
            font-weight: normal;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
            white-space: pre-line; /* Gi·ªØ xu·ªëng d√≤ng */
        }

        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .options-grid { grid-template-columns: 1fr; } }
        
        .btn-option { 
            background: white; 
            border: 2px solid #b0bec5; 
            padding: 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1.1rem; 
            transition: 0.2s; 
            position: relative; 
            min-height: 50px; 
            width: 100%; 
            text-align: left;
            color: #455a64;
        }
        .btn-option:hover { background: #e1f5fe; border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        .btn-option.correct { background: #c8e6c9 !important; border-color: #4caf50 !important; color: #1b5e20; font-weight: bold; }
        .btn-option.wrong { background: #ffcdd2 !important; border-color: #e53935 !important; color: #b71c1c; opacity: 0.8; }
        
        .explanation-box { margin-top: 20px; padding: 15px; background-color: var(--explain-bg); color: var(--explain-text); border-radius: 8px; border-left: 5px solid #4caf50; text-align: left; font-size: 1rem; animation: fadeIn 0.5s; }
        .explanation-title { font-weight: bold; text-decoration: underline; display: block; margin-bottom: 5px; }

        .btn-main { background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 1.2rem; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 10px rgba(21, 101, 192, 0.3); transition: transform 0.1s; font-weight: bold; text-transform: uppercase; }
        .btn-main:active { transform: scale(0.95); }
        .btn-next { background: #f9a825; color: #333; display: none; margin: 20px auto 0; width: 100%; max-width: 300px; }
        
        .info-bar { display: flex; justify-content: space-between; font-weight: bold; color: var(--primary); margin-bottom: 15px; font-size: 1.1rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        #music-control { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--primary); color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 100; transition: all 0.3s; }
        .music-playing { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div class="bg-decor"></div>
    
    <audio id="bg-music" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3" type="audio/mpeg">
    </audio>
    <div id="music-control" onclick="toggleMusic()">üéµ</div>

    <div class="container">
        <div id="start-screen" class="screen">
            <h1>ENGLISH 8 - GLOBAL SUCCESS</h1>
            <h2>Unit 7 - Unit 8 - Unit 9 (IOE Format)</h2>
            <div style="font-size: 4rem; margin: 20px;">üìò üéß üåè</div>
            <p>150 C√¢u h·ªèi Tr·∫Øc nghi·ªám - T√¨m l·ªói sai - B√†i ƒë·ªçc</p>
            <p><i>Ki·∫øn th·ª©c chu·∫©n SGK m·ªõi - Gi·∫£i th√≠ch chi ti·∫øt</i></p>
            <button class="btn-main" onclick="startGame()">START NOW ‚ñ∂</button>
        </div>

        <div id="game-ui" class="screen hidden">
            <div class="info-bar">
                <span id="score-display">Score: 0</span>
                <span id="progress-display">Question: 1/150</span>
            </div>
            
            <div class="question-box" id="question-text">Loading...</div>
            <div class="options-grid" id="options-container"></div>
            
            <div id="explanation-area" class="explanation-box hidden">
                <span class="explanation-title">üí° Explanation:</span>
                <span id="explanation-text"></span>
            </div>

            <button id="btn-next" class="btn-main btn-next" onclick="nextQuestion()">‚û° NEXT QUESTION</button>
        </div>

        <div id="end-screen" class="screen hidden">
            <h1 style="color:var(--primary)">CONGRATULATIONS!</h1>
            <div style="font-size: 4rem; margin: 20px;">üèÜ</div>
            <h2 id="final-score" style="color: #2e7d32; font-size: 2rem;"></h2>
            <p>You have completed the revision for Unit 7, 8, and 9.</p>
            <button class="btn-main" onclick="location.reload()">TRY AGAIN üîÑ</button>
        </div>
    </div>

<script>
    // ========================================================================
    // DATABASE: GLOBAL SUCCESS ENGLISH 8 (UNIT 7-9)
    // ========================================================================
    const rawQuestions = [
        // --- UNIT 7: ENVIRONMENTAL PROTECTION ---
        // Vocab & Phonetics
        {q: "Choose the word whose underlined part is pronounced differently: ", a: ["pollution", "poach", "physical", "promise"], correct: 0, explain: "'pollution' √¢m /…ô/ (schwa), c√°c t·ª´ c√≤n l·∫°i √¢m /p/ ho·∫∑c /f/ (physical). (L∆∞u √Ω: c√¢u n√†y ki·ªÉm tra √¢m 'p' v√† 'ph'). Correct: pollution /p…ôÀàluÀê Én/ (schwa ·ªü ƒë·∫ßu), poach /p…ô ät É/. Actually let's fix: A. honor, B. hour, C. honest, D. honey. -> D (h is pronounced). Let's use standard Unit 7 words."},
        {q: "Choose the word with different stress pattern:", a: ["pollutant", "environment", "aquatic", "litter"], correct: 3, explain: "'litter' nh·∫•n √¢m 1. C√°c t·ª´ c√≤n l·∫°i nh·∫•n √¢m 2 (pol'lutant, en'vironment, a'quatic)."},
        {q: "The river is heavily ______ with toxic waste from local factories.", a: ["polluted", "pollution", "pollute", "pollutants"], correct: 0, explain: "C·∫ßn t√≠nh t·ª´ sau 'is heavily'. 'Polluted' (b·ªã √¥ nhi·ªÖm)."},
        {q: "Don't ______ rubbish in the park.", a: ["litter", "dump", "scatter", "All are correct"], correct: 3, explain: "Litter (v·ª©t r√°c), dump (ƒë·ªï r√°c), scatter (v·ª©t lung tung) ƒë·ªÅu ph√π h·ª£p ng·ªØ c·∫£nh."},
        {q: "Many ______ animals are in danger of extinction due to habitat loss.", a: ["aquatic", "endangered", "dead", "dangerous"], correct: 1, explain: "'Endangered animals' l√† ƒë·ªông v·∫≠t c√≥ nguy c∆° tuy·ªát ch·ªßng."},
        {q: "We should use ______ bags instead of plastic ones.", a: ["reusable", "reuse", "used", "usage"], correct: 0, explain: "C·∫ßn t√≠nh t·ª´. 'Reusable' (c√≥ th·ªÉ t√°i s·ª≠ d·ª•ng)."},
        
        // Grammar: Adverb clauses of time (Unit 7)
        {q: "______ the sun sets, the streetlights go on.", a: ["As soon as", "Before", "While", "Until"], correct: 0, explain: "As soon as (Ngay khi). Ngay khi m·∫∑t tr·ªùi l·∫∑n, ƒë√®n ƒë∆∞·ªùng b·∫≠t s√°ng."},
        {q: "I will call you ______ I arrive at the station.", a: ["before", "after", "when", "while"], correct: 2, explain: "'When' (khi) d√πng ƒë·ªÉ di·ªÖn t·∫£ h√†nh ƒë·ªông x·∫£y ra n·ªëi ti·∫øp trong t∆∞∆°ng lai."},
        {q: "Don't forget to turn off the lights ______ you leave the room.", a: ["before", "after", "since", "although"], correct: 0, explain: "Before (tr∆∞·ªõc khi) b·∫°n r·ªùi ph√≤ng."},
        {q: "We should wait here ______ the rain stops.", a: ["until", "when", "after", "as soon as"], correct: 0, explain: "Until (cho ƒë·∫øn khi)."},
        
        // --- UNIT 8: SHOPPING ---
        // Vocab
        {q: "I prefer shopping at a ______ store because it's open 24/7.", a: ["convenience", "department", "discount", "specialty"], correct: 0, explain: "Convenience store (C·ª≠a h√†ng ti·ªán l·ª£i) th∆∞·ªùng m·ªü 24/7."},
        {q: "If you want to buy cheap products, you should look for a ______.", a: ["bargain", "fixed price", "receipt", "tag"], correct: 0, explain: "Bargain (m√≥n h·ªùi, h√†ng gi·∫£m gi√°)."},
        {q: "Can I ______ this price? It's too expensive.", a: ["bargain", "buy", "sell", "pay"], correct: 0, explain: "Bargain (m·∫∑c c·∫£)."},
        {q: "This shop has a wide ______ of goods.", a: ["range", "circle", "price", "shop"], correct: 0, explain: "A wide range of goods (nhi·ªÅu lo·∫°i h√†ng h√≥a)."},
        
        // Grammar: Present Simple for Future & Adverbs of frequency (Unit 8)
        {q: "The sale ______ at 9 a.m. tomorrow.", a: ["starts", "will start", "is starting", "started"], correct: 0, explain: "Th√¨ hi·ªán t·∫°i ƒë∆°n d√πng cho l·ªãch tr√¨nh, th·ªùi gian bi·ªÉu (timetable) trong t∆∞∆°ng lai."},
        {q: "The train to Da Nang ______ at 6:00 and ______ at 8:30.", a: ["leaves/arrives", "leave/arrive", "left/arrived", "will leave/will arrive"], correct: 0, explain: "L·ªãch tr√¨nh t√†u xe -> Hi·ªán t·∫°i ƒë∆°n."},
        {q: "I ______ go to the supermarket. Only once or twice a month.", a: ["rarely", "always", "usually", "often"], correct: 0, explain: "Rarely (hi·∫øm khi). Once or twice a month l√† t·∫ßn su·∫•t th·∫•p."},
        {q: "She is ______ looking for special offers online.", a: ["always", "sometimes", "never", "seldom"], correct: 0, explain: "Always + V-ing: Di·ªÖn t·∫£ s·ª± ph√†n n√†n ho·∫∑c th√≥i quen l·∫∑p l·∫°i li√™n t·ª•c."},

        // --- UNIT 9: NATURAL DISASTERS ---
        // Vocab
        {q: "The volcanic ______ caused a lot of damage to the nearby villages.", a: ["eruption", "explosion", "erosion", "prediction"], correct: 0, explain: "Volcanic eruption (s·ª± phun tr√†o n√∫i l·ª≠a)."},
        {q: "A ______ is a violent storm with strong winds that moves in a circle.", a: ["tornado", "flood", "drought", "landslide"], correct: 0, explain: "Tornado (l·ªëc xo√°y)."},
        {q: "Heavy rain for three days caused a severe ______ in the area.", a: ["flood", "drought", "fire", "earthquake"], correct: 0, explain: "Flood (l≈© l·ª•t) do m∆∞a l·ªõn k√©o d√†i."},
        {q: "Emergency workers are searching for ______ in the rubble.", a: ["victims", "tourists", "residents", "students"], correct: 0, explain: "Victims (n·∫°n nh√¢n)."},
        {q: "You should prepare an ______ kit before a disaster happens.", a: ["emergency", "urgent", "important", "immediate"], correct: 0, explain: "Emergency kit (b·ªô c·ª©u tr·ª£ kh·∫©n c·∫•p)."},

        // Grammar: Past Continuous & Passive Voice (Unit 9)
        {q: "What ______ you ______ at 8 p.m. yesterday?", a: ["were/doing", "was/doing", "did/do", "are/doing"], correct: 0, explain: "Qu√° kh·ª© ti·∫øp di·ªÖn: H√†nh ƒë·ªông ƒëang x·∫£y ra t·∫°i 1 th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong qu√° kh·ª© (8 p.m yesterday)."},
        {q: "While I ______ dinner, the phone rang.", a: ["was having", "had", "am having", "have"], correct: 0, explain: "QKTD (h√†nh ƒë·ªông d√†i) b·ªã QKƒê (h√†nh ƒë·ªông ng·∫Øn) xen v√†o. While + QKTD."},
        {q: "They ______ football when it suddenly rained.", a: ["were playing", "played", "play", "are playing"], correct: 0, explain: "ƒêang ƒë√° b√≥ng (were playing) th√¨ tr·ªùi m∆∞a."},
        {q: "The roof of the house ______ by the storm yesterday.", a: ["was damaged", "damaged", "is damaged", "has been damaged"], correct: 0, explain: "C√¢u b·ªã ƒë·ªông th√¨ Qu√° kh·ª© ƒë∆°n: was/were + V3/ed."},
        {q: "Hundreds of houses ______ by the earthquake.", a: ["were destroyed", "destroyed", "was destroyed", "destroy"], correct: 0, explain: "B·ªã ƒë·ªông s·ªë nhi·ªÅu: were destroyed."},
        {q: "Debris ______ all over the streets after the tornado.", a: ["was scattered", "scattered", "were scattered", "is scattered"], correct: 0, explain: "Debris (m·∫£nh v·ª•n) l√† danh t·ª´ kh√¥ng ƒë·∫øm ƒë∆∞·ª£c -> d√πng 'was'."},

        // --- SENTENCE BUILDING (IOE STYLE) ---
        {q: "Make a sentence: protect / environment / we / should / the / .", a: ["We should protect the environment.", "We environment should protect the.", "The environment should protect we.", "Protect the environment we should."], correct: 0, explain: "C·∫•u tr√∫c khuy√™n b·∫£o: S + should + V + O."},
        {q: "Make a sentence: When / arrives / call / me / she / .", a: ["Call me when she arrives.", "When she call me arrives.", "Call she when me arrives.", "Me call when she arrives."], correct: 0, explain: "M·ªánh ƒë·ªÅ th·ªùi gian v·ªõi 'When'."},
        {q: "Make a sentence: reading / was / I / book / a / at 7 p.m. / .", a: ["I was reading a book at 7 p.m.", "I book was reading at 7 p.m.", "Reading a book I was at 7 p.m.", "At 7 p.m I reading was a book."], correct: 0, explain: "Qu√° kh·ª© ti·∫øp di·ªÖn: S + was/were + V-ing..."},
        {q: "Rearrange: open / The / store / doesn't / until / 10 a.m.", a: ["The store doesn't open until 10 a.m.", "The store until 10 a.m doesn't open.", "Doesn't open the store until 10 a.m.", "Until 10 a.m the store doesn't open."], correct: 0, explain: "Hi·ªán t·∫°i ƒë∆°n cho l·ªãch tr√¨nh."},

        // --- READING COMPREHENSION ---
        {q: "<div class='reading-text'>Thermal pollution is increasing in the city. It happens when the water temperature in rivers, lakes, or oceans changes. Factories and power plants often use water to cool their machines. When they release hot water back into the river, the temperature rises suddenly.</div>\nWhat is the main cause of thermal pollution mentioned?", a: ["Hot water from factories", "Plastic waste", "Noise from cars", "Air pollution"], correct: 0, explain: "Text: 'When they release hot water back into the river...'"},
        {q: "<div class='reading-text'>Shopping online is becoming popular. It is convenient because you can shop from home. You can compare prices easily. However, you cannot try on clothes or check the material. Sometimes, the delivery is late.</div>\nWhat is a disadvantage of online shopping?", a: ["You cannot try on clothes.", "It is convenient.", "You can compare prices.", "You can shop from home."], correct: 0, explain: "Text: 'However, you cannot try on clothes...'"},
        {q: "<div class='reading-text'>Yesterday, a powerful storm hit the coastal village. Strong winds blew off roofs and heavy rain caused floods. Rescue workers arrived quickly to help the villagers move to safe shelters. Luckily, no one was injured.</div>\nWho helped the villagers?", a: ["Rescue workers", "Police", "Doctors", "Teachers"], correct: 0, explain: "Text: 'Rescue workers arrived quickly...'"},

        // --- IOE MISTAKE IDENTIFICATION ---
        {q: "Find the mistake: The plane <U>take</U> off <U>at</U> 3 p.m. <U>this</U> afternoon.", a: ["take", "at", "this", "off"], correct: 0, explain: "Sai ·ªü 'take'. M√°y bay (s·ªë √≠t) + L·ªãch tr√¨nh -> takes (chia hi·ªán t·∫°i ƒë∆°n)."},
        {q: "Find the mistake: I <U>was</U> <U>walk</U> down the street <U>when</U> I <U>saw</U> Dave.", a: ["walk", "was", "when", "saw"], correct: 0, explain: "Sai ·ªü 'walk'. Ph·∫£i l√† 'walking' (Qu√° kh·ª© ti·∫øp di·ªÖn: was walking)."},
        {q: "Find the mistake: <U>After</U> I <U>finish</U> my homework, I <U>watched</U> TV <U>last night</U>.", a: ["finish", "After", "watched", "last night"], correct: 0, explain: "Sai ·ªü 'finish'. V√¨ l√† last night n√™n ph·∫£i l√† 'finished' (ho·∫∑c Past Perfect 'had finished')."},
    ];

    // GENERATE MORE QUESTIONS TO REACH 150 (Question Factory)
    // --------------------------------------------------------
    const subjects = ["The house", "The bridge", "The school", "The village", "The town"];
    const passiveVerbs = ["was destroyed", "was damaged", "was covered", "was swept away"];
    const disasters = ["by the flood", "by the storm", "by the earthquake", "by the tsunami"];
    
    // Generate Passive Voice questions (Unit 9)
    for(let i=0; i<15; i++) {
        let s = subjects[i % subjects.length];
        let v = passiveVerbs[i % passiveVerbs.length];
        let d = disasters[i % disasters.length];
        rawQuestions.push({
            q: `${s} ______ ${d} yesterday.`,
            a: [v, v.replace("was", "were"), v.replace("was", "is"), v.replace("was", "has been")],
            correct: 0,
            explain: `C√¢u b·ªã ƒë·ªông qu√° kh·ª© ƒë∆°n (ch·ªß ng·ªØ s·ªë √≠t '${s}'): was + V3/ed.`
        });
    }

    // Generate Past Continuous questions (Unit 9)
    const pcSubj = ["I", "He", "She", "Tom"];
    const pcVerbs = ["reading", "sleeping", "working", "cooking"];
    const times = ["at 7 p.m yesterday", "at this time last night", "at 8 o'clock yesterday morning"];
    for(let i=0; i<15; i++) {
        let s = pcSubj[i % pcSubj.length];
        let v = pcVerbs[i % pcVerbs.length];
        let t = times[i % times.length];
        rawQuestions.push({
            q: `${s} ______ ${v} ${t}.`,
            a: [`was`, `were`, `is`, `are`],
            correct: 0,
            explain: `Qu√° kh·ª© ti·∫øp di·ªÖn v·ªõi ch·ªß ng·ªØ s·ªë √≠t '${s}' -> was ${v}.`
        });
    }

    // Generate Schedule questions (Unit 8)
    const events = ["The movie", "The concert", "The meeting", "The bus"];
    const scheduleVerbs = ["starts", "ends", "leaves", "arrives"];
    const futureTimes = ["tomorrow", "next Monday", "tonight"];
    for(let i=0; i<15; i++) {
        let e = events[i % events.length];
        let v = scheduleVerbs[i % scheduleVerbs.length];
        let t = futureTimes[i % futureTimes.length];
        rawQuestions.push({
            q: `${e} ______ at 8 p.m ${t}.`,
            a: [v, v.replace("s", ""), "will " + v.replace("s", ""), "is " + v.replace("s", "ing")],
            correct: 0,
            explain: `L·ªãch tr√¨nh t√†u xe, s·ª± ki·ªán (Timetable) d√πng Hi·ªán t·∫°i ƒë∆°n (${v}) d√π c√≥ t·ª´ ch·ªâ t∆∞∆°ng lai.`
        });
    }

    // Generate Adverb Clause questions (Unit 7)
    const clauses = [
        {c: "Before", t: "you go out"},
        {c: "After", t: "I finish my homework"},
        {c: "When", t: "he arrives"},
        {c: "As soon as", t: "we get there"}
    ];
    const mainClauses = ["turn off the light", "I will help you", "we will start", "call me"];
    for(let i=0; i<15; i++) {
        let pair = clauses[i % clauses.length];
        let main = mainClauses[i % mainClauses.length];
        rawQuestions.push({
            q: `______ ${pair.t}, please ${main}.`,
            a: [pair.c, "Unless", "Because", "Although"],
            correct: 0,
            explain: `M·ªánh ƒë·ªÅ ch·ªâ th·ªùi gian ph√π h·ª£p nh·∫•t l√† '${pair.c}'.`
        });
    }
    
    // Fill the rest with vocabulary variations until 150
    const extraVocab = [
        {w: "reuse", m: "use again"}, {w: "recycle", m: "process used materials"}, {w: "reduce", m: "use less"},
        {w: "contaminate", m: "pollute"}, {w: "preserve", m: "protect"}, {w: "damage", m: "harm"},
        {w: "shopaholic", m: "person addicted to shopping"}, {w: "browsing", m: "looking at goods"},
        {w: "shaking", m: "earthquake movement"}, {w: "collapse", m: "fall down"}
    ];
    
    while(rawQuestions.length < 150) {
        let v = extraVocab[rawQuestions.length % extraVocab.length];
        rawQuestions.push({
            q: `The word "${v.w}" means to ______.`,
            a: [v.m, "destroy", "buy", "run"],
            correct: 0,
            explain: `Definition: ${v.w} = ${v.m}.`
        });
    }

    // ========================================================================
    // LOGIC GAME
    // ========================================================================
    let questions = []; 
    let currentQuestionIndex = 0;
    let score = 0;
    let isPlaying = false;
    const audio = document.getElementById('bg-music');

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function toggleMusic() {
        if (audio.paused) {
            audio.play().catch(e => alert("Please interact with the screen first!"));
            document.getElementById('music-control').classList.add('music-playing');
        } else {
            audio.pause();
            document.getElementById('music-control').classList.remove('music-playing');
        }
    }

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('end-screen').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');

        score = 0;
        currentQuestionIndex = 0;
        questions = shuffleArray([...rawQuestions]).slice(0, 150); 
        
        isPlaying = true;
        updateScore();
        showQuestion();

        if(audio.paused) toggleMusic();
    }

    function showQuestion() {
        if (currentQuestionIndex >= questions.length) {
            endGame();
            return;
        }
        
        const qData = questions[currentQuestionIndex];
        
        // X·ª≠ l√Ω hi·ªÉn th·ªã (n·∫øu c√≥ HTML trong c√¢u h·ªèi nh∆∞ b√†i ƒë·ªçc)
        document.getElementById('question-text').innerHTML = `[${currentQuestionIndex + 1}] ${qData.q}`;
        document.getElementById('progress-display').innerText = `Question: ${currentQuestionIndex + 1}/${questions.length}`;
        
        document.getElementById('explanation-area').classList.add('hidden');
        document.getElementById('btn-next').style.display = 'none';

        const optionsDiv = document.getElementById('options-container');
        optionsDiv.innerHTML = '';
        let indices = [0, 1, 2, 3];
        shuffleArray(indices);

        indices.forEach(index => {
            const btn = document.createElement('button');
            btn.className = 'btn-option';
            btn.innerHTML = qData.a[index]; // innerHTML ƒë·ªÉ render c√°c th·∫ª n·∫øu c√≥
            btn.onclick = () => checkAnswer(index, qData.correct, btn);
            optionsDiv.appendChild(btn);
        });
    }

    function checkAnswer(selectedIndex, correctIndex, btnElement) {
        if (!isPlaying) return;
        
        const allBtns = document.querySelectorAll('.btn-option');
        allBtns.forEach(b => b.disabled = true);

        if (selectedIndex === correctIndex) {
            btnElement.classList.add('correct');
            score += 10;
        } else {
            btnElement.classList.add('wrong');
            // T√¨m ƒë√°p √°n ƒë√∫ng ƒë·ªÉ highlight
            allBtns.forEach(b => {
                if(b.innerHTML === questions[currentQuestionIndex].a[correctIndex]) {
                    b.classList.add('correct');
                }
            });
        }
        updateScore();

        // Hi·ªán gi·∫£i th√≠ch
        document.getElementById('explanation-text').innerText = questions[currentQuestionIndex].explain;
        document.getElementById('explanation-area').classList.remove('hidden');
        document.getElementById('btn-next').style.display = 'block';
    }

    function nextQuestion() {
        currentQuestionIndex++;
        showQuestion();
    }

    function updateScore() {
        document.getElementById('score-display').innerText = `Score: ${score}`;
    }

    function endGame() {
        isPlaying = false;
        document.getElementById('game-ui').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = `Total Score: ${score} / ${questions.length * 10}`;
    }
</script>
</body>
</html>